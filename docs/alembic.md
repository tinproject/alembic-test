# Migrations with alembic


## documentation links and articles

* http://alembic.readthedocs.org/en/latest/index.html
* http://www.chesnok.com/daily/2013/07/02/a-practical-guide-to-using-alembic/
* https://julo.ch/blog/alembic-introduction/
* https://julo.ch/blog/migrating-content-with-alembic/
* https://github.com/davidism/basic_flask

## commands

- alembic init - inits the alembic structure
- alembic revision -m "message" --autogenerate - Create a new revision, autogenerates upgrade/
downgrade code (must be revised) with 'message' as a identification message
- alembic history - show the revisions history
- alembic heads - show the code of the head/s revision/s
- alembic current - shows the revision that maps the current structure of the database
- alembic show 'rev' - show revision 'rev' data
- alembic upgrade 'rev' - upgrade db structure to the 'rev' revision
- alembic upgrade 'rev' -- sql - same as before but do it on offline mode, give the sql code
- alembic upgrade head - updates to the head revision
- alembic downgrade 'rev'  - downgrade db structure to 'rev' revision

## practises

Start first revision with the model or with a fresh start (empty db)

Test the upgrade on a controlled environment with the same data as in production.

Also test downgrade script for assure that the autogenerated code it's valid.


## related utilities

* sqlacodegen https://bitbucket.org/agronholm/sqlacodegen/src Creates a code model from database using reflection.


## process of init alembic environment with flask

- init alembic environment, to a 'alembic' folder:
"$ alembic init alembic"
- modify alembic.ini: set "revision_environment = true" so always load env.py, change also file_template if wanted
- modify env.py to load sqlalchemy.url and target_metadata from flask app. Modify as needed:
```python
# load flask app directory so packages can be imported
import sys
from os.path import abspath, dirname
sys.path.insert(0, dirname(dirname(abspath(__file__))))

# import app factory, db
from flaskapp import create_app
from flaskapp.models import db

# get an app and extract url from config
app = create_app()
config.set_main_option("sqlalchemy.url", app.config["SQLALCHEMY_DATABASE_URI"])
sqlalchemy_url = app.config['SQLALCHEMY_DATABASE_URI']
with app.app_context():
    target_metadata = db.metadata
```
- execute '$ alembic revision --autogenerate -m "Initial revision" ' to set the first revision (load the current model structure)

## process of upgrading database structure

- Change the models on the flask app.
- Execute ' $ alembic revision --autogenerate -m "text explaining the operations to the model" '
- Change revision upgrade and downgrade autogenerated code so work as expected.
- Test upgrade and downgrade on a 'staging' environment. Assure that both are working correctly before applying on porduction.
- Execute ' $ alembic upgrade head ' to update the database.
